name: Deploy to CloudHub 2.0 (Manual + Automatic)

on:
  # TRIGGER 1: MANUAL 
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment Environment
        required: true
        type: choice
        options:
          - Sandbox
          - Production
      target:
        description: CloudHub 2.0 Target/Space
        required: true
        type: string
        default: Cloudhub-US-East-2
      replicas:
        description: Number of Replicas
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      vcores:
        description: vCores per Replica
        required: true
        type: choice
        options:
          - '0.1'
          - '1'
          - '2'
          - '4'
      java:
        description: Java Version
        required: true
        type: choice
        options:
          - '8'
          - '17'
      runtime:
        description: Mule Runtime Version
        required: true
        type: choice
        options:
          - '4.9.8'
          - '4.10.0'
      commit:
        description: Deployment Description
        required: true
        type: string

  # TRIGGER 2: AUTOMATIC ON CODE PUSH (works with both main and master)
  push:
    branches:
      - main
      - master
    paths:
      - 'src/**'                
      - 'pom.xml'               
      - 'settings.xml'          

  # TRIGGER 3: SCHEDULED (10 PM DAILY)
  schedule:
    - cron: '0 22 * * *'

run-name: |
  ${{ github.event_name == 'workflow_dispatch' && format('Manual Deploy - {0} - {1}', inputs.environment, inputs.target) ||
      github.event_name == 'push' && 'Auto Deploy (Push) - Sandbox' ||
      github.event_name == 'schedule' && 'Scheduled Deploy - Sandbox' }}

env:
  MAVEN_CACHE_KEY: maven-cache
  DEPLOY_ENV: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'Sandbox' }}
  DEPLOY_TARGET: ${{ github.event_name == 'workflow_dispatch' && inputs.target || 'Cloudhub-US-East-2' }}
  DEPLOY_REPLICAS: ${{ github.event_name == 'workflow_dispatch' && inputs.replicas || '2' }}
  DEPLOY_VCORES: ${{ github.event_name == 'workflow_dispatch' && inputs.vcores || '1' }}
  DEPLOY_JAVA: ${{ github.event_name == 'workflow_dispatch' && inputs.java || '17' }}
  DEPLOY_RUNTIME: ${{ github.event_name == 'workflow_dispatch' && inputs.runtime || '4.9.8' }}
  DEPLOY_TIMEOUT: '900'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Deployment Config
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘    DEPLOYMENT CONFIGURATION            â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "  Trigger Type: ${{ github.event_name }}"
          echo "  Environment: ${{ env.DEPLOY_ENV }}"
          echo "  Target: ${{ env.DEPLOY_TARGET }}"
          echo "  Replicas: ${{ env.DEPLOY_REPLICAS }}"
          echo "  vCores: ${{ env.DEPLOY_VCORES }}"
          echo "  Java: ${{ env.DEPLOY_JAVA }}"
          echo "  Runtime: ${{ env.DEPLOY_RUNTIME }}"
          echo "  Deployment Timeout: ${{ env.DEPLOY_TIMEOUT }}s"
          echo "  Branch: ${{ github.ref }}"
          echo "  Commit: ${{ github.sha }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Validate Resource Configuration
        run: |
          VCORES=${{ env.DEPLOY_VCORES }}
          REPLICAS=${{ env.DEPLOY_REPLICAS }}
          
          if (( $(echo "$VCORES < 0.5" | bc -l) )); then
            echo "âš ï¸  WARNING: vCores should be at least 0.5 for stable deployments"
          fi
          
          if [ "$REPLICAS" -lt 2 ] && [ "${{ env.DEPLOY_ENV }}" = "Production" ]; then
            echo "âš ï¸  WARNING: Production deployments should have at least 2 replicas"
          fi
          
          echo "âœ… Configuration validation complete"

  build:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.DEPLOY_JAVA }}

      - name: Build Application
        run: |
          echo "ğŸ”¨ Building Mule Application..."
          mvn clean package -DskipTests
          echo "âœ… Build Complete"
          ls -lh target/*.jar

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mule-app-build
          path: target/*.jar
          retention-days: 7

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.DEPLOY_JAVA }}

      - name: Verify Settings.xml
        run: |
          if [ -f "settings.xml" ]; then
            echo "âœ… settings.xml found"
          else
            echo "âŒ settings.xml not found"
            exit 1
          fi

      - name: Publish to Anypoint Exchange
        env:
          CLIENT_ID: ${{ secrets.CONNECTED_APP_ID }}
          CLIENT_SECRET: ${{ secrets.CONNECTED_APP_SECRET }}
        run: |
          echo "ğŸ“¦ Publishing to Anypoint Exchange..."
          mvn deploy -s settings.xml -DskipTests
          echo "âœ… Published to Exchange"

  deploy:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.DEPLOY_JAVA }}

      - name: Determine App Name
        id: app-name
        run: |
          if [ "${{ env.DEPLOY_ENV }}" == "Production" ]; then
            APP_NAME="test-ci-cd-app-production"
          else
            APP_NAME="test-ci-cd-app-sandbox"
          fi
          
          echo "name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "Deployment App Name: $APP_NAME"

      - name: Deploy to CloudHub 2.0
        env:
          CLIENT_ID: ${{ secrets.CONNECTED_APP_ID }}
          CLIENT_SECRET: ${{ secrets.CONNECTED_APP_SECRET }}
          GRANT_TYPE: client_credentials
        run: |
          echo "ğŸš€ Deploying to CloudHub 2.0..."
          echo "Environment: ${{ env.DEPLOY_ENV }}"
          echo "Target: ${{ env.DEPLOY_TARGET }}"
          echo "Replicas: ${{ env.DEPLOY_REPLICAS }}"
          echo "vCores: ${{ env.DEPLOY_VCORES }}"
          echo "Deployment Timeout: ${{ env.DEPLOY_TIMEOUT }}s"
          
          mvn clean deploy -DmuleDeploy \
          -e -X \
            -DClientId="$CLIENT_ID" \
            -DClientSecret="$CLIENT_SECRET" \
            -DGrantType="$GRANT_TYPE" \
            -Denvironment="${{ env.DEPLOY_ENV }}" \
            -Dapplication.name="${{ steps.app-name.outputs.name }}" \
            -DjavaVersion="${{ env.DEPLOY_JAVA }}" \
            -Dreplicas="${{ env.DEPLOY_REPLICAS }}" \
            -DvCores="${{ env.DEPLOY_VCORES }}" \
            -Dregion="${{ env.DEPLOY_TARGET }}" \
            -Druntime="${{ env.DEPLOY_RUNTIME }}" \
            -DdeploymentTimeout="${{ env.DEPLOY_TIMEOUT }}" \
            -DskipTests

      - name: Wait for Application Stability
        run: |
          echo "â³ Waiting for application to stabilize (30 seconds)..."
          sleep 30
          echo "âœ… Stability check complete"

      - name: Deployment Success
        if: success()
        run: |
          echo "âœ… âœ… Successfully deployed to ${{ env.DEPLOY_ENV }}"
          echo "ğŸ“±  App Name: ${{ steps.app-name.outputs.name }}"
          echo "ğŸŒ  Region: ${{ env.DEPLOY_TARGET }}"
          echo "ğŸ“Š  Replicas: ${{ env.DEPLOY_REPLICAS }}"
          echo "ğŸ’¾  vCores: ${{ env.DEPLOY_VCORES }}"
          echo "â˜•  Java: ${{ env.DEPLOY_JAVA }}"
          echo "ğŸš€  Runtime: ${{ env.DEPLOY_RUNTIME }}"

      - name: Deployment Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ”  Please check logs above for details"
          echo "ğŸ“‹  Next steps:"
          echo "   1. Check CloudHub 2.0 logs in Anypoint Platform"
          echo "   2. Verify application has sufficient resources (vCores/Replicas)"
          echo "   3. Check for startup errors in the application logs"
          echo "   4. Verify all environment variables and secrets are correct"